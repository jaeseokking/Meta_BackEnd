<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0/*EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="main_mapper">

	<!--로그인  -->
	<select id="login" parameterType="map" resultType="map">
		SELECT IDX, BIZNO FROM TB_MEMBER
		WHERE  BIZNO = #{BIZNO} and PASS = #{PASS}
	</select>
	
	<!-- 회원 총 리스트 개수  -->
	<select id="stampCounts" parameterType="map" resultType="int">
		select count(*) from TB_RECEIPT_STAMP where SHOP_INFO_NO = (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO}) 
		<if test="startDate != 0 and endDate != 0">
			and STAMP_COMP_DTM between DATE_FORMAT(STR_TO_DATE(${startDate},'%Y%m%d'),'%Y-%m-%d 00:00:00') and DATE_FORMAT(STR_TO_DATE(${endDate},'%Y%m%d'),'%Y-%m-%d 23:59:59') 
		</if>
		<if test="!'all'.equals(selectUse) and selectUse != null">
			and CARWASHYN = #{selectUse}
		</if>
	</select> 
	

	
	<!-- 엑셀 세차권 리스트 가져오기  -->
	<select id="excellist" parameterType="map" resultType="map">
		select DATE_FORMAT(CARWASHUSETIME, '%Y-%m-%d %H:%i:%S') AS CARWASHUSETIME, DATE_FORMAT(FRT_CREA_DTM, '%Y-%m-%d %H:%i:%S') AS FRT_CREA_DTM, SEQ, SALES_TOT_AMT, CARWASHYN 
		from TB_RECEIPT_ISSUE where SHOP_BIZNO = #{shop_bizno} 
		<if test="startDate != 0 and endDate != 0">
			and FRT_CREA_DTM between DATE_FORMAT(STR_TO_DATE(${startDate},'%Y%m%d'),'%Y-%m-%d 00:00:00') and DATE_FORMAT(STR_TO_DATE(${endDate},'%Y%m%d'),'%Y-%m-%d 23:59:59') 
		</if>
		<if test="!'all'.equals(selectUse) and selectUse != null">
			and CARWASHYN = #{selectUse}
		</if>
	</select> 
	
	
	
	<!-- 비밀번호 변경  -->
	<update id="updatePW" parameterType="map" >
		update TB_MEMBER SET PASS = #{NewPW} WHERE BIZNO = #{BIZNO}
	</update>
	
	
	<!-- 스탬프 세팅 -->
	<insert id="stampSetting">
		INSERT INTO TB_STAMP_CONDITION(MINIMUM_PRICE, MINIMUM_COUNT,STAMP_EXP, START_DATE, END_DATE, COMPLETION_STAMP, REWARD, MEMBER_IDX)
		VALUES(#{minimum_price, jdbcType=INTEGER}, #{minimum_count, jdbcType=INTEGER},#{stamp_exp, jdbcType=INTEGER}, #{startDate}, #{endDate}, #{completion_stamp}, #{reward}, #{MEMBER_IDX})
		ON DUPLICATE KEY UPDATE
		MINIMUM_PRICE = #{minimum_price, jdbcType=INTEGER}, MINIMUM_COUNT = #{minimum_count, jdbcType=INTEGER}, STAMP_EXP = #{stamp_exp, jdbcType=INTEGER}, START_DATE = #{startDate}, END_DATE = #{endDate}, COMPLETION_STAMP = #{completion_stamp}, REWARD = #{reward}
	</insert>
	
	<!-- 스탬프 값 가져오기 -->
	<select id="getStampSetting" resultType="map" parameterType="int">
		SELECT * FROM TB_STAMP_CONDITION
		WHERE MEMBER_IDX = #{idx}
	</select>
	
	
	<!-- 스탬프 리스트 가져오기  -->
	<select id="stampList" parameterType="map" resultType="map">
		SELECT SEQ, STAMP_CODE, STAMP_COMP_DTM, STAMP_END_DTM, STAMP_CNT, STAMP_USE_YN FROM TB_RECEIPT_STAMP 
		WHERE  SHOP_INFO_NO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO}) 
		<if test="startDate != 0 and endDate != 0">
			and STAMP_COMP_DTM between DATE_FORMAT(STR_TO_DATE(${startDate},'%Y%m%d'),'%Y-%m-%d 00:00:00') and DATE_FORMAT(STR_TO_DATE(${endDate},'%Y%m%d'),'%Y-%m-%d 23:59:59') 
		</if >
		<if test="!'all'.equals(selectUse) and selectUse != null">
			and STAMP_USE_YN = #{selectUse}
		</if>
		order by STAMP_COMP_DTM desc LIMIT #{firstpage} , 10  
	</select> 
	
	<!-- 스템프 디테일 정보 가져오기 -->
	<select id="getStampDetail" parameterType="map" resultType="map">
		SELECT * FROM TB_RECEIPT_STAMP 
		WHERE SHOP_INFO_NO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO}) AND SEQ = #{SEQ} AND STAMP_CODE = #{STAMP_CODE}
	</select>
	
	<!-- 스탬프 수정 -->
	<update id="updateStamp" parameterType="map">
		UPDATE TB_RECEIPT_STAMP SET STAMP_USE_YN = #{STAMP_USE_YN}
		WHERE SHOP_INFO_NO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO}) AND SEQ = #{SEQ} AND STAMP_CODE = #{STAMP_CODE}
	</update>
	
	
	<!-- 공지사항 리스트 가져오기  -->
	<select id="noticeList" parameterType="map" resultType="map">
		SELECT IDX, TITLE, DATE FROM TB_NOTICE 
		WHERE PERMISSION = 1
		order by DATE desc LIMIT #{firstpage} , 10  
	</select> 
	
	
	<!-- 공지사항 리스트 개수  -->
	<select id="noticeCounts" parameterType="map" resultType="int">
		select count(*) from TB_NOTICE WHERE PERMISSION = 1
		<!-- <if test="startDate != 0 and endDate != 0">
			and STAMP_COMP_DTM between DATE_FORMAT(STR_TO_DATE(${startDate},'%Y%m%d'),'%Y-%m-%d 00:00:00') and DATE_FORMAT(STR_TO_DATE(${endDate},'%Y%m%d'),'%Y-%m-%d 23:59:59') 
		</if>
		<if test="!'all'.equals(selectUse) and selectUse != null">
			and CARWASHYN = #{selectUse}
		</if> -->
	</select> 
	
	<!--공지사항 상세정보 보기 -->
	<select id="noticeDetail" parameterType="map" resultType="map">
		SELECT IDX, TITLE, CONTENT, DATE FROM TB_NOTICE
		WHERE PERMISSION = 1 AND IDX = #{IDX}
	</select>
	
	<!-- 문의글 리스트 가져오기 -->
	<select  id="enquiryList" parameterType="map" resultType="map">
		SELECT IDX, TITLE, DATE FROM TB_ENQUIRY 
		WHERE WHO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO})
		order by DATE desc LIMIT #{firstpage} , 10  
	</select>
	
	
	<!-- 문의글 리스트 개수  -->
	<select id="enquiryCounts" parameterType="map" resultType="int">
		select count(*) from TB_ENQUIRY WHERE WHO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO})
		<!-- <if test="startDate != 0 and endDate != 0">
			and STAMP_COMP_DTM between DATE_FORMAT(STR_TO_DATE(${startDate},'%Y%m%d'),'%Y-%m-%d 00:00:00') and DATE_FORMAT(STR_TO_DATE(${endDate},'%Y%m%d'),'%Y-%m-%d 23:59:59') 
		</if>
		<if test="!'all'.equals(selectUse) and selectUse != null">
			and CARWASHYN = #{selectUse}
		</if> -->
	</select> 
	
	<!--문의글 상세정보 보기 -->
	<select id="enquiryDetail" parameterType="map" resultType="map">
		SELECT IDX, TITLE, CONTENT, DATE, KIND ,UPDATED_DATE FROM TB_ENQUIRY 
		WHERE IDX = #{IDX} AND WHO IN (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO})
		
	</select>
	
	<!-- 문의글 답변 가져오기 -->
	<select id="enquiryReply" parameterType="map" resultType="map">
		SELECT CONTENT FROM TB_ENQUIRY_REPLY
		WHERE ENQUIRY_NUM = #{IDX} 
	</select>
	
	<!-- 문의글 작성 -->
	<insert id="enquiryWrite" parameterType="map">
		INSERT INTO TB_ENQUIRY (TITLE, KIND, CONTENT, WHO, DATE)
		VALUES(#{TITLE}, #{CATEGORY}, #{CONTENT}, (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO}), NOW())
	</insert>
	
	<!-- 문의글 수정 -->
	<update id="enquiryUpdate" parameterType="map">
		UPDATE TB_ENQUIRY SET TITLE = #{TITLE} , KIND = #{CATEGORY}, CONTENT=#{CONTENT}, UPDATED_DATE = NOW()
		WHERE IDX = #{IDX} AND WHO = (SELECT SHOP_INFO_NO FROM TB_RECEIPT_SHOP WHERE SHOP_BIZNO = #{BIZNO})
	</update>
	

</mapper>